<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>TagHipster</title>
	<meta name="description" content="">
	<meta name="author" content="alex & ondrej">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<link rel="stylesheet" href="Styles/style.css?v=2">
    <link rel="stylesheet" media="handheld" href="Styles/handheld.css?v=2">
	<script src="Scripts/modernizr-1.7.min.js" type="text/javascript"></script>


    <style>
        body
        {
            background-color: #dedede;
        }
    
        #ui > div
        {
            position: fixed;
        }

        ul
        {
            list-style: none;
        }
        
        #images
        {
            background: url(Images/shadow-top.png) #6b6b6b repeat-x bottom;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
        }

        #images li
        {
            float: left;
        }
              
        #boardWrapper
        {
            top: 100px;
            left: 0;
            bottom: 90px;
            right: 250px;
            overflow: auto;
        }

        #board
        {
            height: 100%;
            width: 100%;
        }
        
        #board img
        {
            position: absolute;
        }
        
        #board canvas
        {
            position: absolute;
        }
        
        #areas
        {
            background-color: #ffd800;
            width: 250px;
            top: 100px;
            bottom: 900px;
            right: 0;            
        }
                        
        #toolbar
        {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: url(Images/shadow-bottom.png) #6b6b6b repeat-x top;
        }

        #images li img
        {
            max-width: 120px;
            max-height: 90px;
        }

        #fileOpenDialog
        {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="images">    
            <div class=""><input type="file" id="fileOpenDialog" name="files[]" multiple /></div>
            <ul>
                <li>
                    <img id="image" src="Images/folder32.png" />
                    <p>Open a new image</p>
                </li>
                <li><img src="Samples/IMG_3104.JPG" /></li>
            </ul>
        </div>
        <div id="areas">
            <div>
                <h2>Area 1</h2>
                <ul>
                    <li>Point 1</li>
                    <li>Point 1</li>
                </ul>
            </div>

        </div>

        <div id="boardWrapper">
            <div id="board">
                <img src="Samples/IMG_3104.JPG" />
                <canvas id="canvas"></canvas>
            </div>
        </div>

        

        <div id="toolbar">

        </div>
    </div>

    <script src="Scripts/jquery-1.6.4.js" type="text/javascript"></script>
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">        !window.jQuery && document.write(unescape('%3Cscript src="Scripts/jquery-1.6.4.min.js"%3E%3C/script%3E'))</script>-->
	<!--[if lt IE 7 ]>
	<script src="Scripts/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg');</script>
	<![endif]-->

    <script>
        $("#image").click(function () {
            $("#fileOpenDialog").click();
        });

        var images = new Array();

        function addImageToList(image) {
            $('<li><img src="' + image.data + '" title="' + image.filename + '" /><p>' + image.filename + '<p/></li>')
                .appendTo("#images ul");
        }


        $("#fileOpenDialog").change(function (e) {
            var files = e.target.files; // FileList object

            // Loop through the FileList and render image files as thumbnails.
            for (var i = 0, file; file = files[i]; i++) {

                // Only process image files.
                if (!file.type.match('image.*')) {
                    continue;
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        var image = {
                            filename: theFile.name,
                            data: e.target.result
                        }

                        images.push(image);
                        addImageToList(image);
                    };
                })(file);

                // Read in the image file as a data URL.
                reader.readAsDataURL(file);
            }
        });


        $(function () {

            var canvas = $('#canvas').get(0);
            var offset = $('#canvas').offset();
            var ctx = canvas.getContext('2d');
            var w = h = canvas.width = canvas.height = 300;

            var closeArea = false;
            
            var points = new Array();
            var areas = new Array();
            var currentPoint = false;
            var movePoint = false;

            canvas.addEventListener('mousemove', function (e) {

                canvas.width = canvas.width;

                closeArea = false;
                
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }

                var str = 'Click to add new point.';

                ctx.fillText(str, point.x, point.y);

                for (i = 0; i<points.length; i++) {
                    str = 'Point: ' + i;

                    if (i > 0) {
                        ctx.lineTo(points[i].x, points[i].y);
                        ctx.stroke();
                    }
                    else {
                        ctx.beginPath();
                        ctx.moveTo(points[i].x, points[i].y);
                    }

                    ctx.fillStyle = '#3f3f3f';
                    ctx.fillRect(points[i].x, points[i].y, 5, 5);

                    if ((point.x == points[i].x) && (point.y == points[i].y)) {
                        str = 'Click to move current point.';
                        movePoint = true;
                        currentPoint = point;
                        ctx.fillStyle = '#3f3f3f';
                        ctx.fillRect(point.x, point.y, 0, 0);
                        ctx.font = '18px calibri';
                        ctx.fillText(str, point.x, point.y);
                    }
                }

                /*if ((point.x == points[0].x) && (point.y == points[0].y)) {

                    str = 'Click to close area.';
                    closeArea = true;
                    ctx.fillStyle = '#3f3f3f';
                    ctx.fillRect(point.x, point.y, 0, 0);
                    ctx.font = '18px calibri';
                    ctx.fillText(str, point.x, point.y);
                }*/
                

            }, 0);

            canvas.addEventListener('mousedown', function (e) {

                canvas.width = canvas.width;

                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }

                if (closeArea) {
                    var arrayLength = points.push(point);
                    ctx.closePath();
                    areas.push(points);

                    var str = 'New point added.';
                    ctx.fillStyle = '#3f3f3f';
                    ctx.fillRect(point.x, point.y, 0, 0);
                    ctx.font = '18px calibri';
                    ctx.fillText(str, point.x, point.y);

                    points = new Array();
            }
                if (movePoint) {
                    currentPoint = point;
            }
                else {

                    if (points.length > 0) {
                        var arrayLength = points.push(point);

                    }
                    else {
                        ctx.beginPath();
                        var arrayLength = points.push(point);

                    }
                }

                ctx.stroke();
                }, 0);


        });

</script>

</body>
</html>