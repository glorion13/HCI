<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html lang="en" class="no-js">
<!--<![endif]-->
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>TagHipster</title>
    <meta name="description" content="">
    <meta name="author" content="alex & ondrej">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="Styles/style.css?v=2">
    <link rel="stylesheet" media="handheld" href="Styles/handheld.css?v=2">
    <script src="Scripts/modernizr-1.7.min.js" type="text/javascript"></script>
    <style>
        body, html
        {
            background-color: #dedede;
            overflow: hidden;
        }

        #ui > div
        {
            position: fixed;
        }

        ul
        {
            list-style: none;
        }

        #images
        {
            background: url(Images/shadow-top.png) #6b6b6b repeat-x bottom;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            overflow: auto;
            white-space: nowrap;

        }
            #images ul
            {
                display: inline-block;
            }

            #images li
            { 
                vertical-align: top;
            }
            
            #images li, .button
            {
                border-radius: 2px;  
                border-width: 2px;
                border-style: solid;
                border-color: transparent;
                 
                cursor: pointer;     
                margin: 3px 10px;
                display: inline-block;  
            }
            
            #images li:hover, .button:hover
            {
                /*border: 2px solid #ffd800; */
                border: 2px solid #ebff3f; 
                border-color: #ebff3f;     
            }

                #images li.thumbnail
                {
                    width: 200px;
                }
            
                #images li img
                {
                    max-width: 107px;
                    max-height: 80px;
                    float: left;
                    vertical-align: text-top;
                    margin-right: 10px;
                }
        
        .button
        {
            height: 80px;
            width: 100px;
        }
        
        .button > div
        {
            padding: 60px 4px 4px;
            text-align: center;
        }

        .add-region-button
        {
            background: url(Images/add-region.png) no-repeat center 2px;
        }
        
        .help-button
        {
            background: url(Images/help.png) no-repeat center 2px;
        }
        
        .open-file-button
        {
            background: url(Images/open.png) no-repeat center 2px;
        }

        #boardWrapper
        {
            top: 100px;
            left: 0;
            bottom: 90px;
            right: 250px;
            overflow: hidden;
        }

        #board
        {
            height: 100%;
            width: 100%;
        }

            #board img
            {
                position: absolute;
            }

            #board canvas
            {
                position: absolute;
            }

        #areas
        {
            width: 230px;
            top: 100px;
            bottom: 900px;
            right: 0;
            padding: 10px;
        }

        #toolbar
        {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: url(Images/shadow-bottom.png) #6b6b6b repeat-x top;
        }

        #fileOpenDialog
        {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="images">
            <div class="">
                <input type="file" id="fileOpenDialog" name="files[]" multiple /></div>
            <ul>
                <li id="addImageButton" class="button open-file-button">
                    <div>
                        open new image
                    </div>
                </li>
            </ul>
        </div>
        <div id="areas">
            <div>
                <h2>
                    Area 1</h2>
                <ul>
                    <li>Point 1</li>
                    <li>Point 1</li>
                </ul>
            </div>
        </div>
        <div id="boardWrapper">
            <div id="board">
                <img src="Samples/IMG_3104.JPG" />
                <canvas id="canvas">
                </canvas>
            </div>
        </div>
        <div id="toolbar">
            <div class="button add-region-button">
                <div>new region</div>
            </div>

            <div class="button help-button">
                <div>help</div>
            </div>
        </div>
    </div>
    <script src="Scripts/jquery-1.6.4.js" type="text/javascript"></script>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">        !window.jQuery && document.write(unescape('%3Cscript src="Scripts/jquery-1.6.4.min.js"%3E%3C/script%3E'))</script>-->
    <!--[if lt IE 7 ]>
	<script src="Scripts/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg');</script>
	<![endif]-->
    <script>
        (function ($) {
            function Dictionary() {
                this.keys = new Array();
                this.values = new Array();
            }

            Dictionary.prototype.push = function(key, value) {
                this.keys.push(key);
                this.values.push(value);
            }

            Dictionary.prototype.get = function (key) {
                var index = this.keys.indexOf(key);
                if (index > -1) {
                    return this.values[index];
                }
            }

            Dictionary.prototype.clear = function () {
                this.keys.length = 0;
                this.values.length = 0;
            }

            function distance(a, b) {
                return Math.sqrt(Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2));
            }

            function Image(name, src) {
                this.name = name;
                this.src = src;
                this.areas = new Array();
                this.createArea();
            }

            Image.prototype.createArea = function () {
                var area = new Area();
                this.areas.push(area);
                return area;
            };

            Image.prototype.removeArea = function (area) {
                var index = this.areas.indexOf(area);
                if (index != -1) {
                    this.areas.splice(index, 1);
                }
            };

            Image.prototype.hasPoint = function (point, radius) {
                for (var i = 0; i < this.areas.length; i++) {
                    var area = this.areas[i];
                    var p = area.hasPoint(point, radius);
                    if (p) {
                        return { 
                            area: area,
                            point: p
                        };
                    }
                }
                return false;
            }

            function Area() {
                this.points = new Array();
                this.closed = false;
            }

            Area.prototype.hasPoint = function (point, radius) {
                for (var i = 0; i < this.points.length; i++) {
                    var p = this.points[i];
                    if (distance(point, p) <= radius)
                        return p;
                }
                return false;
            }

            var TagHipster = window.TagHipster = function ($openDialog, $imagePanel, $board, $toolbar, $areaList) {
                this.$openDialog = $openDialog;
                this.$imagePanel = $imagePanel;
                this.$board = $board;
                this.$toolbar = $toolbar;
                this.$areaList = $areaList;

                var images = [];
                var currentImage;
                var currentArea;
                var canvases = new Dictionary();

                function clearBoard() {
                    canvases.clear();
                    $board.find("canvas").remove();
                }

                function addImage(filename, src) {
                    var image = new Image(filename, src);
                    images.push(image);
                    $('<li class="thumbnail"><img src="' + image.src + '" title="' + image.name + '" /><p>' + image.name + '<p/></li>')
                        .appendTo("#images ul")
                        .data("image", image);

                    if (images.length == 1) {
                        selectImage(image);
                    }
                }

                function createCanvas(area) {
                    var imageTag = $board.find("img");

                    var canvas = $('<canvas />');
                    canvas[0].height = imageTag.height();
                    canvas[0].width = imageTag.width();
                    canvas.appendTo($board);
                    canvases.push(area, canvas);

                    return area;
                }

                function createAreaEntry(area) {
                    var areaMarkup = $('<div class="area"><h2>Some area</h2><ul></ul></div>');
                    var list = areaMarkup.find("ul");
                    for (var i = 0; i < area.points.length; i++) {
                        var point = area.points[i];
                        list.append('<li>point ' + i + ': (' + point.x + '; ' + point.y + ')</li>');
                    }
                    
                    areaMarkup.hide().appendTo($areaList).slideDown();
                    areaMarkup.data("area", area);
                }

                function selectImage(image) {
                    currentImage = image;

                    clearBoard();

                    var imageTag = $board.find("img");
                    imageTag.attr("src", image.src);

                    $areaList.empty();
                    for (var i = 0; i < image.areas.length; i++) {
                        var area = image.areas[i];
                        createAreaEntry(area);
                        createCanvas(area);
                        repaintArea(area);
                    }

                    if (image.areas.length > 0) {
                        selectArea(image.areas[image.areas.length - 1]);
                    } else {
                        selectArea(null);
                    }
                }

                function selectArea(area) {
                    currentArea = area;
                }

                function createAndSelectArea() {
                    var area = currentImage.createArea();
                    createCanvas(area);
                    createAreaEntry(area);
                    selectArea(area);
                    return area;
                }

                function startArea(ctx, x, y) {
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }

                function continueArea(ctx, x, y) {
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }

                function clearCanvas(canvas) {
                    canvas[0].width = canvas[0].width;
                }

                function drawPoint(ctx, x, y) {
                    //start drawing
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    //draw arc: arc(x, y, radius, startAngle, endAngle, anticlockwise)
                    ctx.arc(x, y, 5, Math.PI * 2, 0, true);
                    //end drawing
                    ctx.moveTo(x, y);
                    ctx.closePath();
                    ctx.fill();
                }

                function redrawCanvas(ctx, area) {
                    if (area.points.length == 0)
                        return;

                    for (var i = 0; i < area.points.length; i++) {
                        if (i > 0) {
                            continueArea(ctx, area.points[i].x, area.points[i].y);
                        }
                        else {
                            startArea(ctx, area.points[i].x, area.points[i].y);
                        }
                        drawPoint(ctx, area.points[i].x, area.points[i].y);
                    }

                    if (area.closed) {
                        continueArea(ctx, area.points[0].x, area.points[0].y);
                    }
                }

                function repaintArea(area) {
                    var canvas = canvases.get(area);
                    if (!canvas) {
                        alert("canvas lost :(");
                    } else {
                        var context = canvas.data("context");
                        if (!context) {
                            context = canvas[0].getContext('2d');
                            canvas.data("context", context);
                        }
                        clearCanvas(canvas);
                        redrawCanvas(context, area);
                    }
                }

                $imagePanel.find("li:first").click(function () {
                    $("#fileOpenDialog").click();
                });

                $("#images li.thumbnail").live("click", function () {
                    var image = $(this).data("image");
                    selectImage(image);
                    return false;
                });

                $toolbar.find(".add-region-button").click(function () {
                    if (currentImage) {
                        createAndSelectArea();
                    } else {
                        alert("Please open a picture to annotate first.");
                    };
                });

                $openDialog.change(function (e) {
                    var files = e.target.files; // FileList object

                    // Loop through the FileList and render image files as thumbnails.
                    for (var i = 0, file; file = files[i]; i++) {

                        // Only process image files.
                        if (!file.type.match('image.*')) {
                            continue;
                        }

                        var reader = new FileReader();

                        // Closure to capture the file information.
                        reader.onload = (function (theFile) {
                            return function (e) {
                                addImage(theFile.name, e.target.result);
                            };
                        })(file);

                        // Read in the image file as a data URL.
                        reader.readAsDataURL(file);
                    }
                });

                var mouseDown;
                var draggedPoint;
                
                var Mode = {
                    Click: 0,
                    Pan: 1,
                    DragPoint: 2,
                    DragArea: 3,
                    CloseArea: 4
                }

                var currentMode = Mode.Click;

                function getLocalCoords(mouseEvent) {
                    var offset = $board.offset();
                    var coords = {
                        x: mouseEvent.pageX - offset.left,
                        y: mouseEvent.pageY - offset.top
                    }
                    return coords;
                }

                function scrollImage(mouseEvent) {
                    var current = getLocalCoords(mouseEvent);

                    var $scrollView = $board.parent();
                    var left = $scrollView.scrollLeft();
                    left += mouseDown.x - current.x;
                    if (left < 0)
                        left = 0;
                    $scrollView.scrollLeft(left);

                    var top = $scrollView.scrollTop();
                    top += mouseDown.y - current.y;
                    if (top < 0)
                        top = 0;
                    $scrollView.scrollTop(top);
                }

                function dragPoint(mouseEvent) {
                    var current = getLocalCoords(mouseEvent);
                    draggedPoint.x = current.x;
                    draggedPoint.y = current.y;
                    repaintArea(currentArea);
                }

                $board.mousedown(function (e) {
                    if (currentImage) {
                        mouseDown = getLocalCoords(e);
                        currentMode = Mode.Click;

                        if (currentImage) {
                            var locatedPoint = currentImage.hasPoint(mouseDown, 8); 
                            if (locatedPoint) {
                                draggedPoint = locatedPoint.point;
                                if (currentArea && !currentArea.closed && currentArea == locatedPoint.area && currentArea.points[0] == locatedPoint.point) {
                                    currentMode = Mode.CloseArea;
                                } else {
                                    selectArea(locatedPoint.area);
                                    currentMode = Mode.DragPoint;
                                }
                            }
                        }
                        return false;
                    }
                });

                $("body").mousemove(function (e) {
                    if (mouseDown) {
                        var coords = getLocalCoords(e);

                        if (currentMode == Mode.Click) {
                            if (distance(coords, mouseDown) > 5) {
                                currentMode = Mode.Pan;
                            }
                        } else if (currentMode == Mode.CloseArea) {
                            if (distance(coords, mouseDown) > 5) {
                                currentMode = Mode.DragPoint;
                            }
                        }

                        switch (currentMode) {
                            case Mode.Pan:
                                scrollImage(e);
                                break;

                            case Mode.DragPoint:
                                dragPoint(e);
                            default:
                                break;
                        }                      
                    }
                });

                $("body").mouseup(function (e) {
                    if (currentImage) {
                        if (mouseDown) {
                            var coords = getLocalCoords(e);

                            switch (currentMode) {
                                case Mode.Click:
                                    if (!currentArea) {
                                        createAndSelectArea();
                                    }
                                    currentArea.points.push(coords);
                                    repaintArea(currentArea);
                                    break;
                                case Mode.CloseArea:
                                    currentArea.closed = true;
                                    repaintArea(currentArea);
                                    break;

                                default:
                                    break;
                            }
                            mouseDown = null;
                            return false;
                        }
                    }
                });

                $("body").mouseenter(function (e) {
                    if (!e.button) {
                        mouseDown = null;
                    }
                });

                addImage("test", "Samples/IMG_3104.JPG");
            }


        })(jQuery);

        var app = new TagHipster($("#fileOpenDialog"), $("#images"), $("#board"), $("#toolbar"), $("#areas"));
        /*
        function writeOnCanvas(ctx, str, x, y) {
            ctx.font = '18px calibri';
            ctx.fillText(str, x, y);
        }


        function isInRadius(point1, point2, radius) {
            if ((point1.x > point2.x - radius) && (point1.x < point2.x + radius) && (point1.y > point2.y - radius) && (point1.y < point2.y + radius)) {
                return true;
            }
            return false;
        }

        function insertPoint(index, points) {
            // Returns an array with a new point inserted after a given point in a point array

            var newPoint = {
                x: Math.round((points[index].x + points[index + 1].x) / 2),
                y: Math.round((points[index].y + points[index + 1].y) / 2)
            }
            newPointsArray = new Array();
            for (var i = 0; i < index + 1; i++) { newPointsArray.push(points[i]); }
            newPointsArray.push(newPoint);
            for (var i = index + 1; i < points.length; i++) { newPointsArray.push(points[i]); }

            return newPointsArray;
        }

        function isBetween(c, a, b) {
            var crossproduct = (c.y - a.y) * (b.x - a.x) - (c.x - a.x) * (b.y - a.y);
            if (Math.abs(crossproduct) != 0) { return false; }

            var dotproduct = (c.x - a.x) * (b.x - a.x) + (c.y - a.y) * (b.y - a.y);
            if (dotproduct < 0) { return false; }

            var squaredLengthBa = (b.x - a.x) * (b.x - a.x) + (b.y - a.y) * (b.y - a.y);
            if (dotproduct > squaredLengthBa) { return false; }

            return true;
        }

        $(function () {

            var test1 = {
                x: 3,
                y: 3
            }
            var test2 = {
                x: 1,
                y: 1
            }
            var test3 = {
                x: 2,
                y: 2
            }
            //alert(isBetween(test3, test1, test2));

            var canvas = $('#canvas').get(0);
            var offset = $('#canvas').offset();
            var ctx = canvas.getContext('2d');
            var w = canvas.width = 2560;
            var h = canvas.height = 1800;

            var radius = 4;

            var closeArea = false;
            var movePoint = false;
            var areaClosed = false;
            var movement = false;
            var insert = false;

            var movedPoint;
            var currentPoint;

            var points = new Array();
            var areas = new Array();

            canvas.addEventListener('mousemove', function (e) {

                // Initialize and reset some variables
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }
                closeArea = false;
                if (!movement) { movePoint = false; }
                insert = false;

                // Redraw canvas
                redrawCanvas(canvas, ctx, points, radius);

                if (movement) {
                    for (i = 0; i < points.length; i++) {
                        if ((currentPoint.x == points[i].x) && (currentPoint.y == points[i].y)) {
                            points[i] = point;
                            currentPoint = point;
                        }
                    }
                    redrawCanvas(canvas, ctx, points, radius);

                    var str = 'Release button to drop.';
                    writeOnCanvas(ctx, str, point.x, point.y);
                }
                else {
                    for (i = 0; i < points.length; i++) {

                        // If the mouse is over an existing point allow for movement
                        if (isInRadius(point, points[i], radius)) {
                            movePoint = true;
                            currentPoint = points[i];
                        }
                        else if (i > 0) {
                            if (isBetween(point, points[i - 1], points[i])) {
                                insert = true;
                                var str = 'Click to insert point.';
                                writeOnCanvas(ctx, str, point.x, point.y);
                            }
                        }
                    }

                    if (points.length > 0) {
                        // If the mouse is over the first point of the area allow for closure
                        if (isInRadius(point, points[0], radius)) {
                            closeArea = true;
                        }

                        // Print this if the user can close the area
                        if ((closeArea) && (points.length > 2) && (!areaClosed)) {
                            var str = 'Click to close area or drag to move point.';
                            writeOnCanvas(ctx, str, point.x, point.y);
                        }
                        // Print this if the user is over an existing point
                        else if (movePoint) {
                            var str = 'Click and drag to move current point.';
                            writeOnCanvas(ctx, str, point.x, point.y);
                        }
                        else {
                            // Print this only if the area hasn't been closed
                            if (!areaClosed) {
                                var str = 'Click to add new point.';
                                writeOnCanvas(ctx, str, point.x, point.y);
                            }
                        }
                    }
                    else {
                        var str = 'Click to add new point.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                }

            }, 0);

            canvas.addEventListener('mousedown', function (e) {

                // Initialize and reset some variables
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }

                if (movePoint) {
                    movement = true;
                }

            }, 0);

            canvas.addEventListener('mouseup', function (e) {

                movement = false;

                if (!areaClosed) {
                    // Initialize and reset some variables
                    var point = {
                        x: e.pageX - offset.left,
                        y: e.pageY - offset.top
                    }

                    // Redraw canvas
                    redrawCanvas(canvas, ctx, points, radius, areaClosed);

                    // If the first point of the area was clicked then close the area
                    if ((closeArea) && (points.length > 2)) {
                        points.push(points[0]);
                        areas.push(points);
                        areaClosed = true;

                        redrawCanvas(canvas, ctx, points, radius);

                        // Text to print
                        var str = 'Area closed.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                    // If an existing point of the area was clicked then move the point
                    else if (movePoint) {
                    }
                    else if (insert) {
                        points = insertPoint(0, points);
                    }

                    // Otherwise simply the point to the area
                    else {
                        points.push(point);
                        redrawCanvas(canvas, ctx, points, radius);

                        var str = 'New point added.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                }

            }, 0);
        });
        */
</script>
</body>
</html>
