<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>TagHipster</title>
	<meta name="description" content="">
	<meta name="author" content="alex & ondrej">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<link rel="stylesheet" href="Styles/style.css?v=2">
    <link rel="stylesheet" media="handheld" href="Styles/handheld.css?v=2">
	<script src="Scripts/modernizr-1.7.min.js" type="text/javascript"></script>


    <style>
        body
        {
            background-color: #dedede;
        }
    
        #ui > div
        {
            position: fixed;
        }

        ul
        {
            list-style: none;
        }
        
        #images
        {
            background: url(Images/shadow-top.png) #6b6b6b repeat-x bottom;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
        }

        #images li
        {
            float: left;
        }
              
        #boardWrapper
        {
            top: 100px;
            left: 0;
            bottom: 90px;
            right: 250px;
            overflow: auto;
        }

        #board
        {
            height: 100%;
            width: 100%;
        }
        
        #board img
        {
            position: absolute;
        }
        
        #board canvas
        {
            position: absolute;
        }
        
        #areas
        {
            background-color: #ffd800;
            width: 250px;
            top: 100px;
            bottom: 900px;
            right: 0;            
        }
                        
        #toolbar
        {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: url(Images/shadow-bottom.png) #6b6b6b repeat-x top;
        }

        #images li img
        {
            max-width: 120px;
            max-height: 90px;
        }

        #fileOpenDialog
        {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="images">    
            <div class=""><input type="file" id="fileOpenDialog" name="files[]" multiple /></div>
            <ul>
                <li id="addImageButton">
                    <img id="image" src="Images/folder32.png" />
                    <p>Open a new image</p>
                </li>
                <li class="thumbnail">
                    <img src="Samples/IMG_3104.JPG" />
                </li>
            </ul>
        </div>
        <div id="areas">
            <div>
                <h2>Area 1</h2>
                <ul>
                    <li>Point 1</li>
                    <li>Point 1</li>
                </ul>
            </div>

        </div>

        <div id="boardWrapper">
            <div id="board">
                <img src="Samples/IMG_3104.JPG" />
                <canvas id="canvas"></canvas>
            </div>
        </div>

        

        <div id="toolbar">

        </div>
    </div>

    <script src="Scripts/jquery-1.6.4.js" type="text/javascript"></script>
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">        !window.jQuery && document.write(unescape('%3Cscript src="Scripts/jquery-1.6.4.min.js"%3E%3C/script%3E'))</script>-->
	<!--[if lt IE 7 ]>
	<script src="Scripts/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg');</script>
	<![endif]-->

    <script>
        $("#image").click(function () {
            $("#fileOpenDialog").click();
        });

        $("#images li.thumbnail").live("click", function () {
            var image = $(this).find("img");
            if (image) {
                $("#board img").attr("src", image.attr("src"));
                return false;
            }
        });

        var images = new Array();

        function addImageToList(image) {
            $('<li class="thumbnail"><img src="' + image.data + '" title="' + image.filename + '" /><p>' + image.filename + '<p/></li>')
                .appendTo("#images ul");
        }


        $("#fileOpenDialog").change(function (e) {
            var files = e.target.files; // FileList object

            // Loop through the FileList and render image files as thumbnails.
            for (var i = 0, file; file = files[i]; i++) {

                // Only process image files.
                if (!file.type.match('image.*')) {
                    continue;
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        var image = {
                            filename: theFile.name,
                            data: e.target.result
                        }

                        images.push(image);
                        addImageToList(image);
                    };
                })(file);

                // Read in the image file as a data URL.
                reader.readAsDataURL(file);
            }
        });

        function writeOnCanvas(ctx, str, x, y) {
            ctx.fillStyle = '#3f3f3f';
            ctx.fillRect(x, y, 0, 0);
            ctx.font = '18px calibri';
            ctx.fillText(str, x, y);
        }

        function startArea(ctx, x, y) {
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function continueArea(ctx, x, y) {
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function clearCanvas(canvas) {
            canvas.width = canvas.width;
        }

        function redrawCanvas(canvas, ctx, points) {
            clearCanvas(canvas);

            for (i = 0; i < points.length; i++) {
                if (i > 0) {
                    continueArea(ctx, points[i].x, points[i].y);
                }
                else {
                    startArea(ctx, points[i].x, points[i].y);
                }
            }
        }

        $(function () {

            var canvas = $('#canvas').get(0);
            var offset = $('#canvas').offset();
            var ctx = canvas.getContext('2d');
            var w = h = canvas.width = canvas.height = 300;

            var closeArea = false;
            var movePoint = false;
            var currentPoint;
            
            var points = new Array();
            var areas = new Array();

            canvas.addEventListener('mousemove', function (e) {

            // Initialize and reset some variables
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }
                closeArea = false;

                // Redraw canvas
                redrawCanvas(canvas, ctx, points);
                
                // Text to print normally

                for (i = 0; i < points.length; i++) {
                // If the mouse is over an existing point allow for movement
                    if ((point.x == points[i].x) && (point.y == points[i].y)) {
                        movePoint = true;
                        currentPoint = point;
                    }
                }
                // If the mouse is over the first point of the area allow for closure
                if ((point.x == points[0].x) && (point.y == points[0].y)) {
                    closeArea = true;
                }
                if (closeArea) {
                    var str = 'Click to close area.';
                    writeOnCanvas(ctx, str, point.x, point.y);
                }
                else if (movePoint) {
                    var str = 'Click to move current point.';
                    writeOnCanvas(ctx, str, point.x, point.y);
                }
                else {
                    var str = 'Click to add new point.';
                    writeOnCanvas(ctx, str, point.x, point.y);
                }



            }, 0);

            canvas.addEventListener('mousedown', function (e) {

            // Initialize and reset some variables
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }

                // Redraw canvas
                redrawCanvas(canvas, ctx, points);

                // If the first point of the area was clicked then close the area
                if (closeArea) {
                    points.push(point);
                    areas.push(points);

                    // Text to print
                    var str = 'Area closed.';
                    writeOnCanvas(ctx, str, point.x, point.y);
                }
                    // If an existing point of the area was clicked then move the point
                if (movePoint) {
                    // movement of point
            }
                // Otherwise simply the point to the area
                else {
                    points.push(point);
                }
                }, 0);


        });

</script>

</body>
</html>