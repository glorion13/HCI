<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>TagHipster</title>
	<meta name="description" content="">
	<meta name="author" content="alex & ondrej">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<link rel="stylesheet" href="Styles/style.css?v=2">
    <link rel="stylesheet" media="handheld" href="Styles/handheld.css?v=2">
	<script src="Scripts/modernizr-1.7.min.js" type="text/javascript"></script>


    <style>
        body
        {
            background-color: #dedede;
        }
    
        #ui > div
        {
            position: fixed;
        }

        ul
        {
            list-style: none;
        }
        
        #images
        {
            background: url(Images/shadow-top.png) #6b6b6b repeat-x bottom;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
        }

        #images li
        {
            float: left;
        }
              
        #boardWrapper
        {
            top: 100px;
            left: 0;
            bottom: 90px;
            right: 250px;
            overflow: auto;
        }

        #board
        {
            height: 100%;
            width: 100%;
        }
        
        #board img
        {
            position: absolute;
        }
        
        #board canvas
        {
            position: absolute;
        }
        
        #areas
        {
            background-color: #ffd800;
            width: 250px;
            top: 100px;
            bottom: 900px;
            right: 0;            
        }
                        
        #toolbar
        {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: url(Images/shadow-bottom.png) #6b6b6b repeat-x top;
        }

        #images li img
        {
            max-width: 120px;
            max-height: 90px;
        }

        #fileOpenDialog
        {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="images">    
            <div class=""><input type="file" id="fileOpenDialog" name="files[]" multiple /></div>
            <ul>
                <li id="addImageButton">
                    <img id="image" src="Images/folder32.png" />
                    <p>Open a new image</p>
                </li>
                <li class="thumbnail">
                    <img src="Samples/IMG_3104.JPG" />
                </li>
            </ul>
        </div>
        <div id="areas">
            <div>
                <h2>Area 1</h2>
                <ul>
                    <li>Point 1</li>
                    <li>Point 1</li>
                </ul>
            </div>

        </div>

        <div id="boardWrapper">
            <div id="board">
                <img src="Samples/IMG_3104.JPG" />
                <canvas id="canvas"></canvas>
            </div>
        </div>

        

        <div id="toolbar">

        </div>
    </div>

    <script src="Scripts/jquery-1.6.4.js" type="text/javascript"></script>
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">        !window.jQuery && document.write(unescape('%3Cscript src="Scripts/jquery-1.6.4.min.js"%3E%3C/script%3E'))</script>-->
	<!--[if lt IE 7 ]>
	<script src="Scripts/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg');</script>
	<![endif]-->

    <script>
        $("#image").click(function () {
            $("#fileOpenDialog").click();
        });

        $("#images li.thumbnail").live("click", function () {
            var image = $(this).find("img");
            if (image) {
                $("#board img").attr("src", image.attr("src"));
                return false;
            }
        });

        var images = new Array();

        function addImageToList(image) {
            $('<li class="thumbnail"><img src="' + image.data + '" title="' + image.filename + '" /><p>' + image.filename + '<p/></li>')
                .appendTo("#images ul");
        }


        $("#fileOpenDialog").change(function (e) {
            var files = e.target.files; // FileList object

            // Loop through the FileList and render image files as thumbnails.
            for (var i = 0, file; file = files[i]; i++) {

                // Only process image files.
                if (!file.type.match('image.*')) {
                    continue;
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        var image = {
                            filename: theFile.name,
                            data: e.target.result
                        }

                        images.push(image);
                        addImageToList(image);
                    };
                })(file);

                // Read in the image file as a data URL.
                reader.readAsDataURL(file);
            }
        });

        function writeOnCanvas(ctx, str, x, y) {
            ctx.font = '18px calibri';
            ctx.fillText(str, x, y);
        }

        function startArea(ctx, x, y) {
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function continueArea(ctx, x, y) {
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function clearCanvas(canvas) {
            canvas.width = canvas.width;
        }

        function drawPoint(ctx, x, y, radius) {
            //start drawing
            ctx.beginPath();
            //draw arc: arc(x, y, radius, startAngle, endAngle, anticlockwise)
            ctx.arc(x, y, radius, Math.PI * 2, 0, true);
            //end drawing
            ctx.closePath();
            ctx.fill();
        }

        function isInRadius(point1, point2, radius) {
            if ((point1.x > point2.x - radius) && (point1.x < point2.x + radius) && (point1.y > point2.y - radius) && (point1.y < point2.y + radius)) {
                return true;
            }
            return false;
        }

        function redrawCanvas(canvas, ctx, points, radius) {
            clearCanvas(canvas);

            for (i = 0; i < points.length; i++) {
                if (i > 0) {
                    continueArea(ctx, points[i].x, points[i].y);
                }
                else {
                    startArea(ctx, points[i].x, points[i].y);
            }
                drawPoint(ctx, points[i].x, points[i].y, radius);
            }
        }

        function insertPoint(index, points) {
            // Returns an array with a new point inserted after a given point in a point array

            var newPoint = {
                x: Math.round((points[index].x + points[index+1].x) / 2),
                y: Math.round((points[index].y + points[index+1].y) / 2)
            }
            newPointsArray = new Array();
            for (var i = 0; i < index + 1; i++) { newPointsArray.push(points[i]); }
            newPointsArray.push(newPoint);
            for (var i = index + 1; i < points.length; i++) { newPointsArray.push(points[i]); }

            return newPointsArray;
        }

        function isBetween(c, a, b) {
            var crossproduct = (c.y - a.y) * (b.x - a.x) - (c.x - a.x) * (b.y - a.y);
            if (Math.abs(crossproduct) != 0) { return false; }

            dotproduct = (c.x - a.x) * (b.x - a.x) + (c.y - a.y) * (b.y - a.y);
            if (dotproduct < 0) { return false; }

            squaredLengthBa = (b.x - a.x) * (b.x - a.x) + (b.y - a.y) * (b.y - a.y);
            if (dotproduct > squaredLengthBa) { return false; }
      
            return true;
        }

        $(function () {

            var test1 = {
                x: 3,
            y: 3
            }
            var test2 = {
                x: 1,
                y: 1
            }
            var test3 = {
                x: 2,
                y: 2
            }
            alert(isBetween(test3, test1, test2));

            var canvas = $('#canvas').get(0);
            var offset = $('#canvas').offset();
            var ctx = canvas.getContext('2d');
            var w = canvas.width = 2560;
            var h = canvas.height = 1800;

            var radius = 4;

            var closeArea = false;
            var movePoint = false;
            var areaClosed = false;
            var movement = false;
            var insert = false;

            var movedPoint;
            var currentPoint;
            
            var points = new Array();
            var areas = new Array();

            canvas.addEventListener('mousemove', function (e) {

                    // Initialize and reset some variables
                    var point = {
                        x: e.pageX - offset.left,
                        y: e.pageY - offset.top
                    }
                    closeArea = false;
                    if (!movement) { movePoint = false; }
                    insert = false;

                    // Redraw canvas
                    redrawCanvas(canvas, ctx, points, radius);

                    if (movement) {
                        for (i = 0; i < points.length; i++) {
                            if ((currentPoint.x == points[i].x) && (currentPoint.y == points[i].y)) {
                                points[i] = point;
                                currentPoint = point;
                            }
                        }
                        redrawCanvas(canvas, ctx, points, radius);

                        var str = 'Release button to drop.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                    else {
                        for (i = 0; i < points.length; i++) {

                            // If the mouse is over an existing point allow for movement
                            if (isInRadius(point, points[i], radius)) {
                                movePoint = true;
                                currentPoint = points[i];
                            }
                            else if (i > 0) {
                                if (isBetween(point, points[i - 1], points[i])) {
                                    insert = true;
                                    var str = 'Click to insert point.';
                                    writeOnCanvas(ctx, str, point.x, point.y);
                                }
                            }
                        }

                        if (points.length > 0) {
                            // If the mouse is over the first point of the area allow for closure
                            if (isInRadius(point, points[0], radius)) {
                                closeArea = true;
                            }

                            // Print this if the user can close the area
                            if ((closeArea) && (points.length > 2) && (!areaClosed)) {
                                var str = 'Click to close area or drag to move point.';
                                writeOnCanvas(ctx, str, point.x, point.y);
                            }
                            // Print this if the user is over an existing point
                            else if (movePoint) {
                                var str = 'Click and drag to move current point.';
                                writeOnCanvas(ctx, str, point.x, point.y);
                            }
                            else {
                                // Print this only if the area hasn't been closed
                                if (!areaClosed) {
                                    var str = 'Click to add new point.';
                                    writeOnCanvas(ctx, str, point.x, point.y);
                                }
                            }
                        }
                        else {
                            var str = 'Click to add new point.';
                            writeOnCanvas(ctx, str, point.x, point.y);
                        }
                    }

            }, 0);

            canvas.addEventListener('mousedown', function (e) {

                // Initialize and reset some variables
                var point = {
                    x: e.pageX - offset.left,
                    y: e.pageY - offset.top
                }

                if (movePoint) {
                    movement = true;
                }

            }, 0);

            canvas.addEventListener('mouseup', function (e) {

                movement = false;

                if (!areaClosed) {
                    // Initialize and reset some variables
                    var point = {
                        x: e.pageX - offset.left,
                        y: e.pageY - offset.top
                    }
                   
                    // Redraw canvas
                    redrawCanvas(canvas, ctx, points, radius, areaClosed);

                    // If the first point of the area was clicked then close the area
                    if ((closeArea) && (points.length > 2)) {
                        points.push(points[0]);
                        areas.push(points);
                        areaClosed = true;

                        redrawCanvas(canvas, ctx, points, radius);

                        // Text to print
                        var str = 'Area closed.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                    // If an existing point of the area was clicked then move the point
                    else if (movePoint) {
                    }
                    else if (insert) {
                        points = insertPoint(0, points);
                    }

                    // Otherwise simply the point to the area
                    else {
                        points.push(point);
                        redrawCanvas(canvas, ctx, points, radius);

                        var str = 'New point added.';
                        writeOnCanvas(ctx, str, point.x, point.y);
                    }
                }

                }, 0);
        });

</script>

</body>
</html>